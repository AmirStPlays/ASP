import logging
import requests
import queue
import threading
import time
from io import BytesIO
from PIL import Image
from googletrans import Translator
from telegram import Update, Bot
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

# ------ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª ------
TOKEN = "7864181902:AAHn-FMM-BPQ-O8MqB5Fs5XP4Rnv-xZ3aFo"
HF_API_KEY = "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"
MODEL = "stabilityai/stable-diffusion-3.5-large-turbo"

# ------ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯ ------
logging.basicConfig(
    format="%(asctime)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

# ------ Ù…ØªØ±Ø¬Ù… Ú¯ÙˆÚ¯Ù„ ------
translator = Translator()

# ------ ØµÙ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ ------
image_queue = queue.Queue()

# ------ ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø¨Ø§ Stable Diffusion ------
def generate_image(prompt):
    headers = {"Authorization": f"Bearer {HF_API_KEY}"}
    payload = {"inputs": prompt}
    response = requests.post(
        f"https://api-inference.huggingface.co/models/{MODEL}",
        headers=headers,
        json=payload
    )
    if response.status_code == 200:
        return Image.open(BytesIO(response.content))
    else:
        logging.error(f"Error generating image: {response.text}")
        return None

# ------ Ú©Ø§Ø±Ú¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± ------
def image_worker(bot: Bot):
    while True:
        task = image_queue.get()
        update = task["update"]
        prompt = task["prompt"]
        chat_id = update.effective_chat.id
        waiting_message_id = task["waiting_message_id"]

        # ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±
        image = generate_image(prompt)
        
        # Ø­Ø°Ù Ù¾ÛŒØ§Ù… "âŒ›"
        bot.delete_message(chat_id, waiting_message_id)

        if image:
            bio = BytesIO()
            image.save(bio, format="PNG")
            bio.seek(0)
            bot.send_photo(chat_id, photo=bio, caption="Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯ ğŸ˜Š")
        else:
            bot.send_message(chat_id, text="âŒ")

        # ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ API
        time.sleep(20)
        image_queue.task_done()

# ------ Ù‡Ù†Ø¯Ù„Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ ------
def handle_text(update: Update, context: CallbackContext):
    chat_type = update.effective_chat.type
    user_text = update.message.text.strip()

    # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¯Ø± Ú¯Ø±ÙˆÙ‡ ÛŒØ§ Ø³ÙˆÙ¾Ø±Ú¯Ø±ÙˆÙ‡ Ø¨ÙˆØ¯:
    if chat_type in ["group", "supergroup"]:
        if not user_text.startswith("/asp"):
            return  # Ù¾ÛŒØ§Ù… Ø¹Ø§Ø¯ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        prompt = user_text[4:].strip()  # Ø­Ø°Ù "/asp"
        if not prompt:
            update.message.reply_text("Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ù¾Ø³ Ø§Ø² /asp ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
            return

    # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¯Ø± Ù¾ÛŒâ€ŒÙˆÛŒ (private) Ø¨ÙˆØ¯:
    elif chat_type == "private":
        prompt = user_text
    else:
        return  # Ø§Ù†ÙˆØ§Ø¹ Ø¯ÛŒÚ¯Ø± Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±ÛŒÙ…

    # ØªØ±Ø¬Ù…Ù‡ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
    translated_text = translator.translate(prompt, dest="en").text
    logging.info(f"Prompt: {prompt} -> Translated: {translated_text}")

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ù†ØªØ¸Ø§Ø± Ùˆ Ø°Ø®ÛŒØ±Ù‡ `message_id`
    waiting_message = update.message.reply_text("âŒ›")
    waiting_message_id = waiting_message.message_id

    # Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØµÙ
    image_queue.put({
        "update": update,
        "prompt": translated_text,
        "waiting_message_id": waiting_message_id
    })

# ------ Ø¯Ø³ØªÙˆØ± /start Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ ------
def start(update: Update, context: CallbackContext):
    welcome_text = (
        "ğŸ¨ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n\n"
        "â€¢ Ø¯Ø± Ú¯Ø±ÙˆÙ‡: Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\n"
        "/asp Ù…ØªÙ† Ø´Ù…Ø§\n"
        "Ù…Ø«Ø§Ù„: /asp Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§\n\n"
        "â€¢ Ø¯Ø± Ù¾ÛŒâ€ŒÙˆÛŒ: Ù‡Ø± Ù…ØªÙ†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŒ ØªØµÙˆÛŒØ± Ø¢Ù† ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
    )
    update.message.reply_text(welcome_text)

# ------ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª ------
def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.text, handle_text))

    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ±Ø¯ Ú©Ø§Ø±Ú¯Ø± ØµÙ
    worker_thread = threading.Thread(
        target=image_worker,
        args=(updater.bot,),
        daemon=True
    )
    worker_thread.start()

    logging.info("ğŸ¤– Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª...")
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
